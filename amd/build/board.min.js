define ("mod_board/board",["exports","jquery","jqueryui","core/str","core/ajax","core/modal_factory","core/modal_events","core/notification","mod_board/jquery.editable.amd","core/fragment"],function(a,c,d,e,f,g,h,i,j,k){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.default=m;c=l(c);f=l(f);g=l(g);h=l(h);i=l(i);k=l(k);function l(a){return a&&a.__esModule?a:{default:a}}var n=function(a,b,c,d){f.default.call([{methodname:"mod_board_"+a,args:b,done:function done(a){c(a)},fail:function fail(a){i.default.exception(a);if(d){d(a)}}}])},o=function(a){return 13==a||32==a},p=function(a){return(0,c.default)("<div />").text(a).html()},q=function(a){return(0,c.default)("<div />").html(a).text()},r=function(a,b){return a.on("click keypress",function(a){if("keypress"==a.type){if(o(a.keyCode)){a.preventDefault()}else{return}}b()})},s=function(a,b,c){if(a.is(":editable")){throw new Error("handleEditableAction - must be called before setting the element as editable")}return a.on("dblclick keypress",function(d){if("keypress"==d.type){if(o(d.keyCode)&&!a.is(":editing")){d.preventDefault();if(c){b()}a.editable("open");if(c){return}}else{return}}b()})};function m(a,b,d){var f={default_column_heading:"",post_button_text:"",cancel_button_text:"",remove_note_text:"",remove_column_text:"",note_changed_text:"",note_deleted_text:"",rate_note_text:"",Ok:"",Cancel:"",warning:"",modal_title_new:"",modal_title_edit:"",option_youtube:"",option_image:"",option_link:"",aria_newcolumn:"",aria_newpost:"",aria_deletecolumn:"",aria_deletepost:"",aria_addmedia:"",aria_addmedianew:"",aria_deleteattachment:"",aria_postedit:"",aria_canceledit:"",aria_postnew:"",aria_cancelnew:"",aria_ratepost:"",invalid_file_extension:"",invalid_file_size_min:"",invalid_file_size_max:""},j=1,l=2,m=1,o=2,t=null,u=null,v=b.isEditor||!1,w=b.userId||-1,x=b.mediaselection||j,y=0,z=b.readonly||!1,A=b.ratingenabled,B=b.sortby||m,C=null,D=function(a,b,c,d){if("board_history"!==a){ca()}n(a,b,function(){c.apply(null,arguments);if("board_history"!==a&&"get_board"!=a){ba(!0)}},d)},E=function(a){return(0,c.default)(".board_note[data-ident='"+a+"']")},F=function(a){return(0,c.default)(a).find(".mod_board_note_text")},G=function(a){return(0,c.default)(a).find(".mod_board_note_heading")},H=function(a){return(0,c.default)(a).find(".mod_board_note_border")},I=function(a){return(0,c.default)(a).find(".mod_board_note_attachment")},J=function(a){var b=F(a).html(),c=G(a).html(),d=T(a);if(0<c.length){return c}if(0<b.length){return b.replace(/<br\s*\/?>/gi," ").replace(/\n/g," ").split(/\s+/).slice(0,5).join(" ")}if(d.info&&0<d.info.length){return d.info}return null},K=function(a){var b=E(a),c=b.closest(".board_column").find(".mod_board_column_name").text();if(a){var d=J(b),e=f.aria_deletepost.replace("{column}",c).replace("{post}",d);b.find(".delete_note").attr("aria-label",e).attr("title",e);b.find(".mod_board_rating").attr("aria-label",f.aria_ratepost.replace("{column}",c).replace("{post}",d));b.find(".note_ariatext").html(d)}},L=function(a){var b=(0,c.default)(".board_column[data-ident="+a+"]"),d=b.find(".mod_board_column_name").text(),e=f.aria_newpost.replace("{column}",d),g=f.aria_deletecolumn.replace("{column}",d);b.find(".newnote").attr("aria-label",e).attr("title",e);b.find(".delete_column").attr("aria-label",g).attr("title",g);b.find(".board_note").each(function(a,b){K((0,c.default)(b).data("ident"))})},N=function(){if(!y){E(0).remove();return}var a=E(y);if(a){var b=G(a),c=F(a),d=H(a);b.show();d.show();c.show();if(!b.html()){b.hide();d.hide()}if(!c.html()&&b.html()){c.hide();d.hide()}}y=0},O=function(a){if(y){if(y==a){return}N()}if(a){var b=E(0);if(b){b.remove()}}var c=E(a);if(c){ha(c);if(a){y=a}}},P=function(a){i.default.confirm(f.remove_note_text.split("\n")[1],f.remove_note_text.split("\n")[0],f.Ok,f.Cancel,function(){D("delete_note",{id:a},function(b){if(b.status){u=b.historyid;E(a).remove()}})})},Q=function(a){if(!A){return}if(z){return}var b=E(a),c=b.find(".mod_board_rating");if(c.data("disabled")){return}c.data("disabled",!0);D("can_rate_note",{id:a},function(d){if(d){i.default.confirm(f.rate_note_text,null,f.Ok,f.Cancel,function(){D("rate_note",{id:a},function(a){if(a.status){u=a.historyid;c.html(a.rating);if(B==o){da(b.closest(".board_column_content"))}}c.data("disabled",!1)})}).then(function(a){a.getRoot().on(h.default.hidden,function(){c.data("disabled",!1)})})}})},R=function(a){var b=I(a),c=b.find(".mod_board_type").val(),d=b.find(".info"),e=b.find(".url"),g=b.find(".mod_board_file");if("0"<c){d.prop("placeholder",f["option_"+U(c)+"_info"]);e.prop("placeholder",f["option_"+U(c)+"_url"]);d.show();if(c==l&&FileReader){g.show();e.hide()}else{g.hide();e.show()}}else{d.hide();e.hide();g.hide();d.val("");e.val("")}},S=function(a,b){var c=I(a);if(c){if(!b){b={type:"0"}}else{b.type+=""}var d=c.find(".mod_board_type");d.val(b.type?b.type:"0");if("0"<d.val()){c.find(".info").val(q(b.info));c.find(".url").val(q(b.url))}R(a,b)}V(a,b)},T=function(a){var b={type:0,info:null,url:null,filename:null,filecontents:null},c=I(a);if(c.length){b.type=c.find(".mod_board_type").val();b.info=p(c.find(".info").val());b.url=p(c.find(".url").val());var d=c.find(".mod_board_file>input");if(d.data("filename")){b.filename=d.data("filename");b.filecontents=d.data("filecontents")}}if((!b.info||!b.info.length)&&(!b.url||!b.url.length)&&!b.filename){b.type=0}return b},U=function(a){switch(a){case"1":return"youtube";case"2":return"image";case"3":return"link";default:return null;}},V=function(a,b){var c=a.find(".mod_board_preview");if(!b){b=T(a)}var d=function(a){return a.replace(/watch\?v=/gi,"/embed/").replace(/youtu\.be/,"youtube.com/embed")};if(!F(a).html().length){c.addClass("mod_board_notext")}else{c.removeClass("mod_board_notext")}c.removeClass("wrapper_youtube");c.removeClass("wrapper_image");c.removeClass("wrapper_url");if(b.filename&&parseInt(b.type)==l){c.html("<img src=\"".concat(b.filecontents,"\" alt=\"").concat(b.info,"\"\n                class=\"mod_board_preview_element\"/>"));c.addClass("wrapper_image");c.show()}else if(b.url){switch(parseInt(b.type)){case 1:c.html("<iframe src=\""+d(b.url)+"\" class=\"mod_board_preview_element\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write;encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>");c.addClass("wrapper_youtube");c.show();break;case l:c.html("<img src=\"".concat(b.url,"\" alt=\"").concat(b.info,"\"\n                        class=\"mod_board_preview_element\"/>"));c.addClass("wrapper_image");c.show();break;case 3:c.html("<a href=\""+b.url+"\" class=\"mod_board_preview_element\" target=\"_blank\">"+(b.info||b.url)+"</a>");c.addClass("wrapper_url");c.show();break;default:c.html("");c.hide();}}else{c.html("");c.hide()}},W=function(a,b,d,e,f,g,h,i){var j=g.id==w||!b,k=v||j&&!z;if(!b){var l=E(0);if(l){l.remove()}}var m=(0,c.default)("<div class=\"board_note\" data-column=\""+a+"\" data-ident=\""+b+"\" data-sortorder=\""+h+"\"></div>");if(j){m.addClass("mod_board_mynote")}if(k){m.addClass("mod_board_editablenote")}var n=(0,c.default)("<div class=\"mod_board_note_content\"></div>"),o=(0,c.default)("<div class=\"mod_board_note_heading\" tabindex=\"0\">"+(d?d:"")+"</div>"),p=(0,c.default)("<div class=\"mod_board_note_border\"></div>"),q=(0,c.default)("<div class=\"mod_board_note_text\" tabindex=\"0\">"+(e?e:"")+"</div>"),t=(0,c.default)("<div class=\"note_ariatext hidden\" role=\"heading\" aria-level=\"4\" tabindex=\"0\"></div>"),u=(0,c.default)("<div class=\"mod_board_preview\"></div>");n.append(o);n.append(p);n.append(q);n.append(t);n.append(u);m.append(n);var x=(0,c.default)(".board_column[data-ident="+a+"] .board_column_content"),y=function(){O(b)};if(b){if(A){m.addClass("mod_board_rateablenote");var B=(0,c.default)("<div class=\"fa fa-star mod_board_rating\" role=\"button\" tabindex=\"0\"> ".concat(i," </div>"));r(B,function(){Q(b)});n.append(B)}if(k){var C=(0,c.default)("<div class=\"mod_board_remove fa fa-remove delete_note\" role=\"button\" tabindex=\"0\"></div>");r(C,function(){P(b)});n.append(C);s(q,y);s(o,y);s(p,y);S(m,f)}else{V(m,f)}if(!o.html()){o.hide();p.hide()}if(!q.html()&&o.html()){q.hide();p.hide()}var D=x.find(".board_note").last();if(D.length){m.insertAfter(D)}else{x.prepend(m)}}else{(0,c.default)(".board_column[data-ident="+a+"] .board_column_newcontent").append(m);m.hide();y()}},X=function(a,d,e,g){var h="style=\"border-top: 10px solid #".concat(g,"\""),j=v,k=null,l=(0,c.default)("<div class=\"board_column board_column_hasdata\" ".concat(h," data-ident=\"").concat(a,"\"></div>")),m=(0,c.default)("<div class=\"board_column_header\"></div>"),n=(0,c.default)("<div class=\"mod_board_column_sort fa\"></div>"),o=(0,c.default)("<div class=\"mod_board_column_name\" tabindex=\"0\" aria-level=\"3\" role=\"heading\">"+d+"</div>"),p=(0,c.default)("<div class=\"board_column_content\"></div>"),q=(0,c.default)("<div class=\"board_column_newcontent\"></div>");m.append(n);m.append(o);if(b.hideheaders){o.addClass("d-none")}n.on("click",function(){da(p,!0)});if(j){l.addClass("mod_board_editablecolumn");var t=(0,c.default)("<div class=\"mod_board_remove fa fa-remove delete_column\" role=\"button\" tabindex=\"0\"></div>");r(t,function(){i.default.confirm(f.remove_column_text.split(". ")[1],f.remove_column_text.split(". ")[0],f.Ok,f.Cancel,function(){D("delete_column",{id:a},function(a){if(a.status){l.remove();u=a.historyid}})})});m.append(t)}l.append(m);l.append(p);l.append(q);if(j){s(o,function(){k=o.html()},!0);o.editable({toggleFontSize:!1,closeOnEnter:!0,callback:function callback(b){if(b.content){D("update_column",{id:a,name:o.html()},function(b){if(!b.status){o.html(k);k=null}else{u=b.historyid;L(a)}},function(){o.html(k);k=null})}else{o.html(k);k=null}}})}if(!z){q.append("<div class=\"board_button newnote\" role=\"button\" tabindex=\"0\"><div class=\"button_content\"><span class=\"fa "+b.noteicon+"\"></span></div></div>");r(q.find(".newnote"),function(){W(a,0,null,null,null,{id:w},0,0)})}var x=(0,c.default)(".mod_board .board_column_hasdata").last();if(x.length){l.insertAfter(x)}else{(0,c.default)(".mod_board").append(l)}if(e){for(var y in e){W(a,e[y].id,e[y].heading,e[y].content,{type:e[y].type,info:e[y].info,url:e[y].url},{id:e[y].userid},e[y].timecreated,e[y].rating)}}da(p);L(a);if(v){ea()}},Z=function(){var d=(0,c.default)("<div class=\"board_column board_column_empty\"></div>"),e=!1;d.append("<div class=\"board_button newcolumn\" role=\"button\" tabindex=\"0\" aria-label=\""+f.aria_newcolumn+"\" title=\""+f.aria_newcolumn+"\"><div class=\"button_content\"><span class=\"fa "+b.columnicon+"\"></span></div></div>");r(d.find(".newcolumn"),function(){if(e){return}e=!0;D("add_column",{boardid:a.id,name:f.default_column_heading},function(a){X(a.id,f.default_column_heading,{},$());u=a.historyid;e=!1},function(){e=!1})});(0,c.default)(".mod_board").append(d)},$=function(){var a=(0,c.default)(".board_column").length-1,d=b.colours.length;return b.colours[a%d]},_=function(a,b,c){var d=G(a),e=F(a),f=H(a);e.html(c.content);d.html(c.heading);S(a,c.attachment);K(c.id);d.show();f.show();e.show();if(!d.html()){d.hide();f.hide()}if(!e.html()&&d.html()){e.hide();f.hide()}},aa=function(){D("board_history",{id:a.id,since:u},function(b){for(var d in b){var e=b[d];if(e.boardid!=a.id){continue}var g=JSON.parse(e.content);if("add_note"==e.action){W(g.columnid,g.id,g.heading,g.content,g.attachment,{id:e.userid},g.timecreated,g.rating);K(g.id);da((0,c.default)(".board_column[data-ident="+g.columnid+"] .board_column_content"))}else if("update_note"==e.action){(function(){var a=E(g.id),b=C;if(a){var c=G(a);if(y==g.id){i.default.confirm(f.note_changed_text.split("\n")[0],f.note_changed_text.split("\n")[1],f.Ok,f.Cancel,function(){b.hide();_(a,c,g);N()})}else{_(a,c,g)}}})()}else if("delete_note"==e.action){if(y==g.id){i.default.alert(f.warning,f.note_deleted_text);N()}E(g.id).remove()}else if("add_column"==e.action){X(g.id,g.name,{},$())}else if("update_column"==e.action){(0,c.default)(".board_column[data-ident='"+g.id+"'] .mod_board_column_name").html(g.name);L(g.id)}else if("delete_column"==e.action){var h=(0,c.default)(".board_column[data-ident='"+g.id+"']");if(y&&h.find(".board_note[data-ident=\""+y+"\"]").length){N()}h.remove()}else if("rate_note"==e.action){var j=E(g.id);j.find(".mod_board_rating").html(g.rating);if(B==o){da(j.closest(".board_column_content"))}}u=e.id}ba()})},ba=function(a){if(a){aa()}else if(0<b.history_refresh){if(t){ca()}t=setTimeout(aa,1e3*b.history_refresh)}},ca=function(){clearTimeout(t);t=null},da=function(a,b){var d=(0,c.default)(a).parent().find(".mod_board_column_sort"),e=(0,c.default)(a).data("sort");if(!e){if(B==o){e="desc"}else{e="asc"}}if(b){e="asc"==e?"desc":"asc"}if("asc"==e){d.removeClass("fa-angle-down");d.addClass("fa-angle-up")}else{d.removeClass("fa-angle-up");d.addClass("fa-angle-down")}(0,c.default)(a).data("sort",e);var f,g;if(B==m){f=function(d,a){return(0,c.default)(a).data("sortorder")-(0,c.default)(d).data("sortorder")};g=function(d,a){return(0,c.default)(d).data("sortorder")-(0,c.default)(a).data("sortorder")}}else{f=function(d,a){return(0,c.default)(a).find(".mod_board_rating").text()-(0,c.default)(d).find(".mod_board_rating").text()||(0,c.default)(a).data("sortorder")-(0,c.default)(d).data("sortorder")};g=function(d,a){return(0,c.default)(d).find(".mod_board_rating").text()-(0,c.default)(a).find(".mod_board_rating").text()||(0,c.default)(d).data("sortorder")-(0,c.default)(a).data("sortorder")}}(0,c.default)("> .board_note",(0,c.default)(a)).sort("asc"===e?g:f).appendTo((0,c.default)(a))},ea=function(){(0,c.default)(".board_column_content").sortable({connectWith:".board_column_content",stop:function stop(a,b){var d=(0,c.default)(b.item),e=d.closest(".board_column"),f=e.data("ident"),g=(0,c.default)(this);D("move_note",{id:d.data("ident"),columnid:f},function(a){if(a.status){u=a.historyid;K(d.data("ident"));da((0,c.default)(".board_column[data-ident="+f+"] .board_column_content"))}else{g.sortable("cancel")}})}})},fa=function(a,b){return k.default.loadFragment("mod_board","note_form",d,{noteid:a,columnid:b})},ga=function(a,b){var c=a.closest(".board_column").find(".mod_board_column_name").text(),d,e,g,h,i,k=b.getRoot();if(a.data("ident")){var l=J(a);h=f.aria_postedit.replace("{column}",c).replace("{post}",l);i=f.aria_canceledit.replace("{column}",c).replace("{post}",l);d=f.aria_addmedia.replace("{type}",f.option_youtube).replace("{column}",c).replace("{post}",l);e=f.aria_addmedia.replace("{type}",f.option_image).replace("{column}",c).replace("{post}",l);g=f.aria_addmedia.replace("{type}",f.option_link).replace("{column}",c).replace("{post}",l)}else{h=f.aria_postnew.replace("{column}",c);i=f.aria_cancelnew.replace("{column}",c);d=f.aria_addmedianew.replace("{type}",f.option_youtube).replace("{column}",c);e=f.aria_addmedianew.replace("{type}",f.option_image).replace("{column}",c);g=f.aria_addmedianew.replace("{type}",f.option_link).replace("{column}",c)}if(x==j){k.find(".mod_board_attachment_button.youtube_button").attr("aria-label",d);k.find(".mod_board_attachment_button.youtube_button").attr("title",d);k.find(".mod_board_attachment_button.image_button").attr("aria-label",e);k.find(".mod_board_attachment_button.image_button").attr("title",e);k.find(".mod_board_attachment_button.link_button").attr("aria-label",g);k.find(".mod_board_attachment_button.link_button").attr("title",g)}var m=k.find(b.getActionSelector("save"));if(m){m.attr("aria-label",h)}m=k.find(b.getActionSelector("cancel"));if(m){m.attr("aria-label",i)}},ha=function(a){var b=0,e=a.data("column"),i=(0,c.default)(".board_column[data-ident="+e+"]"),k=i.find(".mod_board_column_name").text(),l;if(a.data("ident")){b=a.data("ident");l=f.modal_title_edit.replace("{column}",k)}else{l=f.modal_title_new.replace("{column}",k)}g.default.create({type:g.default.types.SAVE_CANCEL,title:l,body:fa(b,e),large:!0,removeOnClose:!0}).then(function(b){b.getBodyPromise().then(function(){var g=!1;C=b;b.setLarge();b.setSaveButtonText(f.post_button_text);b.setButtonText("cancel",f.cancel_button_text);b.getRoot().on(h.default.hidden,function(){N();if(!a.data("ident")){a.remove()}});b.getRoot().on(h.default.save,function(a){a.preventDefault();b.getRoot().find("form").submit()});var i=document.createEvent("HTMLEvents");i.initEvent("change",!0,!0);b.getRoot().on("submit","form",function(f){f.preventDefault();if(g){return}g=!0;var h=b.getRoot().find("form").get(0).reportValidity();if(!h){return}b.getRoot().find(":input").each(function(a,b){b.dispatchEvent(i)});var j=c.default.merge(b.getRoot().find("[aria-invalid=\"true\"]"),b.getRoot().find(".error"),b.getRoot().find(":invalid"));if(j.length){j.first().focus();return}var k=JSON.stringify(b.getRoot().find("form").serialize());D("submit_form",{contextid:d,jsonformdata:k},function(d){if(d.status){if("insert"==d.action){u=d.historyid;a.remove();W(e,d.note.id,d.note.heading,d.note.content,{type:d.note.type,info:d.note.info,url:d.note.url},{id:d.note.userid},d.note.timecreated,d.note.rating);da((0,c.default)(".board_column[data-ident="+e+"] .board_column_content"));K(d.note.id)}else{u=d.historyid;F(a).html(d.note.content);G(a).html(d.note.heading);K(d.note.id);S(a,{type:d.note.type,info:d.note.info,url:d.note.url})}N();Y.use("moodle-core-formchangechecker",function(){M.core_formchangechecker.reset_form_dirty_state()});b.destroy()}})});if(x==j){b.getRoot().find("#fitem_id_mediatype").hide();var k=b.getRoot().find("#fitem_id_mediatype select"),l=b.getRoot().find(".mod_board_attachment_button.youtube_button"),m=b.getRoot().find(".mod_board_attachment_button.image_button"),n=b.getRoot().find(".mod_board_attachment_button.link_button"),o=function(){l.removeClass("selected");m.removeClass("selected");n.removeClass("selected");switch(k.val()){case"1":l.addClass("selected");break;case"2":m.addClass("selected");break;case"3":n.addClass("selected");break;}};o();r(l,function(){if("1"===k.val()){k.val(0)}else{k.val(1)}o();k[0].dispatchEvent(i)});r(m,function(){if("2"===k.val()){k.val(0)}else{k.val(2)}o();k[0].dispatchEvent(i)});r(n,function(){if("3"===k.val()){k.val(0)}else{k.val(3)}o();k[0].dispatchEvent(i)})}else{b.getRoot().find("#fitem_id_mediabuttons").hide()}ga(a,b);b.show();return b});return b})},ia=function(){D("get_board",{id:a.id},function(c){if(c){for(var d in c){X(c[d].id,c[d].name,c[d].notes||{},b.colours[d%b.colours.length])}}if(v){Z()}u=a.historyid;if(v){ea()}ba()})},ja=[];for(var ka in f){ja.push({key:ka,component:"mod_board"})}c.default.when((0,e.get_strings)(ja)).done(function(a){var b=0;for(ka in f){f[ka]=a[b++]}ia()})}return a.default});
//# sourceMappingURL=board.min.js.map
