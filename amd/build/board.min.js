define ("mod_board/board",["exports","jquery","jqueryui","core/str","core/ajax","core/notification","mod_board/jquery.editable.amd"],function(a,c,d,e,f,g){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.default=i;c=h(c);f=h(f);g=h(g);function h(a){return a&&a.__esModule?a:{default:a}}var j=function(a,b,c,d){f.default.call([{methodname:"mod_board_"+a,args:b,done:function done(a){c(a)},fail:function fail(a){g.default.exception(a);if(d){d(a)}}}])},k=function(a){return 13==a||32==a},l=function(a){return(0,c.default)("<div />").text(a).html()},m=function(a){return(0,c.default)("<div />").html(a).text()},n=function(a,b){return a.on("click keypress",function(a){if("keypress"==a.type){if(k(a.keyCode)){a.preventDefault()}else{return}}b()})},o=function(a,b,c){if(a.is(":editable")){throw new Error("handleEditableAction - must be called before setting the element as editable")}return a.on("dblclick keypress",function(d){if("keypress"==d.type){if(k(d.keyCode)&&!a.is(":editing")){d.preventDefault();if(c){b()}a.editable("open");if(c){return}}else{return}}b()})};function i(a,b){var d={default_column_heading:"",post_button_text:"",cancel_button_text:"",remove_note_text:"",remove_column_text:"",note_changed_text:"",note_deleted_text:"",rate_note_text:"",Ok:"",Cancel:"",warning:"",option_youtube:"",option_youtube_info:"",option_youtube_url:"",option_image:"",option_image_info:"",option_image_url:"",option_link:"",option_link_info:"",option_link_url:"",option_empty:"",aria_newcolumn:"",aria_newpost:"",aria_deletecolumn:"",aria_deletepost:"",aria_addmedia:"",aria_addmedianew:"",aria_deleteattachment:"",aria_postedit:"",aria_canceledit:"",aria_postnew:"",aria_cancelnew:"",aria_choosefilenew:"",aria_choosefileedit:"",aria_ratepost:"",choose_file:"",invalid_file_extension:"",invalid_file_size_min:"",invalid_file_size_max:""},f=1,h=1,i=2,k=3,p=1,q=2,r=null,s=null,t=b.isEditor||!1,u=b.userId||-1,v=b.mediaselection||f,w=null,x=null,y=null,z=0,A=b.readonly||!1,B=b.file.extensions,C=b.file.size_min,D=b.file.size_max,E=b.ratingenabled,F=b.sortby||p,G=function(a,b,c,d){if("board_history"!==a){ka()}j(a,b,function(){c.apply(null,arguments);if("board_history"!==a&&"get_board"!=a){ja(!0)}},d)},H=function(a){return(0,c.default)(".board_note[data-ident='"+a+"']")},I=function(a){return(0,c.default)(".board_note[data-ident='"+a+"'] .note_text")},J=function(a){return(0,c.default)(a).find(".note_text")},K=function(a){return(0,c.default)(".board_note[data-ident='"+a+"'] .note_heading")},L=function(a){return(0,c.default)(a).find(".note_heading")},M=function(a){return(0,c.default)(a).find(".note_buttons")},N=function(){(0,c.default)(".board_column .board_column_newcontent .board_button.newnote").show()},O=function(){(0,c.default)(".board_column .board_column_newcontent .board_button.newnote").hide()},P=function(a){return(0,c.default)(a).find(".note_attachment")},Q=function(a){var b=J(a).html(),c=L(a).html(),d=$(a);if(0<c.length){return c}if(0<b.length){return b.replace(/<br\s*\/?>/gi," ").replace(/\n/g," ").split(/\s+/).slice(0,5).join(" ")}if(d.info&&0<d.info.length){return d.info}return null},R=function(a){var b=H(a),c=b.closest(".board_column").find(".column_name").text(),e="",g="",h="",i="",j="",k="",l="";if(!a){e=d.aria_postnew.replace("{column}",c);g=d.aria_cancelnew.replace("{column}",c);h=d.aria_addmedianew.replace("{type}",d.option_youtube).replace("{column}",c);i=d.aria_addmedianew.replace("{type}",d.option_image).replace("{column}",c);j=d.aria_addmedianew.replace("{type}",d.option_link).replace("{column}",c);l=d.aria_choosefilenew.replace("{column}",d.columnIdentifier)}else{var m=Q(b);e=d.aria_postedit.replace("{column}",c).replace("{post}",m);g=d.aria_canceledit.replace("{column}",c).replace("{post}",m);h=d.aria_addmedia.replace("{type}",d.option_youtube).replace("{column}",c).replace("{post}",m);i=d.aria_addmedia.replace("{type}",d.option_image).replace("{column}",c).replace("{post}",m);j=d.aria_addmedia.replace("{type}",d.option_link).replace("{column}",c).replace("{post}",m);k=d.aria_deleteattachment.replace("{column}",c).replace("{post}",m);l=d.aria_choosefileedit.replace("{column}",c).replace("{post}",m);b.find(".delete_note").attr("aria-label",d.aria_deletepost.replace("{column}",c).replace("{post}",m));b.find(".rating").attr("aria-label",d.aria_ratepost.replace("{column}",c).replace("{post}",m));b.find(".note_ariatext").html(m)}if(v==f){if(a){var n=b.find(".remove_attachment");if(n){n.attr("aria-label",k)}}b.find(".attachment_button.youtube_button").attr("aria-label",h);b.find(".attachment_button.image_button").attr("aria-label",i);b.find(".attachment_button.link_button").attr("aria-label",j)}b.find(".post_button").attr("aria-label",e);b.find(".cancel_button").attr("aria-label",g);b.find(".choose_file_button").attr("aria-label",l)},S=function(a){var b=(0,c.default)(".board_column[data-ident="+a+"]"),e=b.find(".column_name").text();b.find(".newnote").attr("aria-label",d.aria_newpost.replace("{column}",e));b.find(".delete_column").attr("aria-label",d.aria_deletecolumn.replace("{column}",e));b.find(".board_note").each(function(a,b){R((0,c.default)(b).data("ident"))})},T=function(){w=null;x=null;y=null;U()},U=function(){if(!z){H(0).remove();N();return}if(w){I(z).html(w);w=null}if(x){K(z).html(x);x=null}var a=H(z);if(a){if(y){Z(a,y);y=null}else{da(a)}M(a).hide();P(a).hide();N();var b=L(a);if(!b.html()){b.hide()}}z=0},V=function(a){if(z){if(z==a){return}U()}if(a){var b=H(0);if(b){b.remove()}}var c=H(a);if(c){M(c).show();P(c).show();O();var d=L(c);if(a){y=$(c);w=J(c).html();x=d.html();z=a}d.show()}},W=function(a){g.default.confirm(d.remove_note_text.split("\n")[1],d.remove_note_text.split("\n")[0],d.Ok,d.Cancel,function(){G("delete_note",{id:a},function(b){if(b.status){s=b.historyid;H(a).remove()}})})},X=function(a){if(!E){return}if(A){return}var b=H(a),c=b.find(".rating");if(c.data("disabled")){return}c.data("disabled",!0);G("can_rate_note",{id:a},function(e){if(e){g.default.confirm(d.rate_note_text,null,d.Ok,d.Cancel,function(){G("rate_note",{id:a},function(a){if(a.status){s=a.historyid;c.html(a.rating);if(F==q){la(b.closest(".board_column_content"))}}c.data("disabled",!1)})})}})},Y=function(a){var b=P(a),c=b.find(".type").val(),e=b.find(".info"),g=b.find(".url"),h=b.find(".file");if(v==f){var j=b.find(".type_icon"),k=b.find(".remove_attachment")}else{M(a).find(".attachment_button").hide()}if("0"<c){if(v==f){k.show()}e.prop("placeholder",d["option_"+_(c)+"_info"]);g.prop("placeholder",d["option_"+_(c)+"_url"]);e.show();if(c==i&&FileReader){h.show();g.hide()}else{h.hide();g.show()}if(v==f){j.removeClass().addClass(["type_icon","fa",ba(c)]);j.show();M(a).find(".attachment_button").hide()}}else{if(v==f){k.hide()}e.hide();g.hide();h.hide();if(v==f){j.hide()}e.val("");g.val("");if(v==f){M(a).find(".attachment_button").show()}}},Z=function(a,b){var c=P(a);if(c){if(!b){b={type:"0"}}else{b.type+=""}var d=c.find(".type");d.val(b.type?b.type:"0");if("0"<d.val()){c.find(".info").val(m(b.info));c.find(".url").val(m(b.url))}Y(a,b)}da(a,b)},$=function(a){var b={type:0,info:null,url:null,filename:null,filecontents:null},c=P(a);if(c.length){b.type=c.find(".type").val();b.info=l(c.find(".info").val());b.url=l(c.find(".url").val());var d=c.find(".file>input");if(d.data("filename")){b.filename=d.data("filename");b.filecontents=d.data("filecontents")}}if((!b.info||!b.info.length)&&(!b.url||!b.url.length)&&!b.filename){b.type=0}return b},_=function(a){switch(a){case"1":return"youtube";case"2":return"image";case"3":return"link";default:return null;}},aa=["fa-youtube","fa-picture-o","fa-link"],ba=function(a){return aa[a-1]||null},ca=function(a,b){var c=P(a);if(c.length){var e=c.find(".file>input");if(FileReader&&e.prop("files").length){var f=e.prop("files")[0];if(-1==B.indexOf(f.name.split(".").pop().toLowerCase())){g.default.alert(d.warning,d.invalid_file_extension)}else if(f.size<C){g.default.alert(d.warning,d.invalid_file_size_min)}else if(f.size>D){g.default.alert(d.warning,d.invalid_file_size_max)}else{e.data("filename",f.name);var h=new FileReader;h.onload=function(){e.data("filecontents",h.result);b();e.val("")};h.readAsDataURL(f)}}else{b()}}else{b()}},da=function(a,b){var c=a.find(".preview");if(!b){b=$(a)}var d=function(a){return a.replace(/watch\?v=/gi,"/embed/").replace(/youtu\.be/,"youtube.com/embed")};if(!J(a).html().length){c.addClass("notext")}else{c.removeClass("notext")}c.removeClass("wrapper_youtube");c.removeClass("wrapper_image");c.removeClass("wrapper_url");if(b.filename&&parseInt(b.type)==i){c.html("<img src=\""+b.filecontents+"\" class=\"preview_element\" alt=\""+b.info+"\"/>");c.addClass("wrapper_image");c.show()}else if(b.url){switch(parseInt(b.type)){case h:c.html("<iframe src=\""+d(b.url)+"\" class=\"preview_element\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write;encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>");c.addClass("wrapper_youtube");c.show();break;case i:c.html("<img src=\""+b.url+"\" class=\"preview_element\" alt=\""+b.info+"\"/>");c.addClass("wrapper_image");c.show();break;case k:c.html("<a href=\""+b.url+"\" class=\"preview_element\" target=\"_blank\">"+(b.info||b.url)+"</a>");c.addClass("wrapper_url");c.show();break;default:c.html("");c.hide();}}else{c.html("");c.hide()}},ea=function(a,e,g,j,l,m,p,q){var r=m.id==u||!e,w=t||r&&!A;if(!e){var x=H(0);if(x){x.remove()}}var y=(0,c.default)("<div class=\"board_note\" data-ident=\""+e+"\" data-sortorder=\""+p+"\"></div>");if(r){y.addClass("mynote")}if(w){y.addClass("editablenote")}var B=(0,c.default)("<div class=\"note_content\"></div>"),C=(0,c.default)("<div class=\"note_heading\" tabindex=\"0\">"+(g?g:"")+"</div>"),D=(0,c.default)("<div class=\"note_text\" tabindex=\"0\">"+(j?j:"")+"</div>"),F=(0,c.default)("<div class=\"note_ariatext hidden\" role=\"heading\" aria-level=\"4\" tabindex=\"0\"></div>"),I=(0,c.default)("<div class=\"preview\"></div>");if(w){var J=(0,c.default)("<div class=\"note_attachment form-group row\" tabindex=\"0\"><select class=\"type form-control form-control-sm "+(v==f?"hidden":"")+"\"><option value=\"0\">"+d.option_empty+"</option><option value=\""+h+"\">"+d.option_youtube+"</option><option value=\""+i+"\">"+d.option_image+"</option><option value=\""+k+"\">"+d.option_link+"</option></select><span class=\"type_icon fa "+(v==2?"hidden":"")+"\"></span><input type=\"text\" class=\"info form-control form-control-sm col-sm-12 "+(v==f?"with_type_icon":"")+"\" placeholder=\"\"><input type=\"text\" class=\"url form-control form-control-sm col-sm-12\" placeholder=\"\"><div class=\"file form-control form-control-sm\"><label for=\"file"+e+"\" class=\"choose_file_button action_button p-0 w-100\" tabindex=\"0\">"+d.choose_file+"</label><input id=\"file"+e+"\" type=\"file\" class=\"d-none\"></div></div>");J.hide()}B.append(C);B.append(D);B.append(F);if(w){B.append(J)}B.append(I);y.append(B);if(w){var K=J.find(".type"),L=J.find(".info"),M=J.find(".url"),O=J.find(".file>input");K.on("change",function(){Y(y);da(y)});M.on("change",function(){da(y)});O.on("change",function(){ca(y,function(){da(y)})});L.on("change",function(){da(y)});if(v==f){var P=(0,c.default)("<div class=\"remove remove_attachment fa fa-remove\"></div>");P.hide();P.on("click",function(){K.val(0);K.trigger("change")});J.append(P)}}var Q=(0,c.default)(".board_column[data-ident="+a+"] .board_column_content");if(w){var S=(0,c.default)("<div class=\"note_buttons\"></div>");S.hide();var _=(0,c.default)("<div class=\"post_button action_button\" role=\"button\" tabindex=\"0\">"+d.post_button_text+"</div>"),ba=(0,c.default)("<div class=\"cancel_button action_button\" role=\"button\" tabindex=\"0\">"+d.cancel_button_text+"</div>");S.append(_);S.append(ba);if(v==f){S.append("<div class=\"spacer_button\"></div>");var fa=(0,c.default)("<div class=\"attachment_button youtube_button action_button fa "+aa[0]+"\" role=\"button\" tabindex=\"0\"></div>");n(fa,function(){K.val(1);K.trigger("change")});var ga=(0,c.default)("<div class=\"attachment_button image_button action_button fa "+aa[1]+"\" role=\"button\" tabindex=\"0\"></div>");n(ga,function(){K.val(2);K.trigger("change")});var ha=(0,c.default)("<div class=\"attachment_button link_button action_button fa "+aa[2]+"\" role=\"button\" tabindex=\"0\"></div>");n(ha,function(){K.val(3);K.trigger("change")});S.append(fa);S.append(ga);S.append(ha)}y.append(S);var ia=(0,c.default)("<div class=\"remove fa fa-remove delete_note\" role=\"button\" tabindex=\"0\"></div>");n(ia,function(){W(e)});if(!e){ia.hide()}B.append(ia);n(ba,function(){U()});D.on("click",function(){if(z&&z==e||!e){D.editable("open")}});var ja=function(){V(e)};C.on("click",function(){if(z&&z==e||!e){C.editable("open")}});I.on("dblclick",ja);n(_,function(){var c=$(y);C.editable("close");var d=C.html();D.editable("close");var f=D.html().substring(0,b.post_max_length);if(!d&&!f&&!c.url&&!c.filename){return}if(_.data("disabled")){return}_.data("disabled",!0);if(!e){G("add_note",{columnid:a,heading:d,content:f,attachment:c},function(b){if(b.status){s=b.historyid;y.remove();N();ea(a,b.note.id,b.note.heading,b.note.content,{type:b.note.type,info:b.note.info,url:b.note.url},{id:b.note.userid},b.note.timecreated,b.note.rating);la(Q);R(b.note.id)}else{_.data("disabled",!1)}})}else{G("update_note",{id:e,heading:d,content:f,attachment:c},function(a){if(a.status){s=a.historyid;T();D.html(a.note.content);R(e);Z(y,{type:a.note.type,info:a.note.info,url:a.note.url})}_.data("disabled",!1)})}});o(D,ja);D.editable({toggleFontSize:!1,closeOnEnter:!1,callback:function callback(){D.html(D.html().substring(0,b.post_max_length))}});o(C,ja);C.editable({toggleFontSize:!1,closeOnEnter:!0});Z(y,l)}else{da(y,l)}if(e){if(E){y.addClass("rateablenote");var ka=(0,c.default)("<div class=\"fa fa-star rating\" role=\"button\" tabindex=\"0\">"+q+"</div>");n(ka,function(){X(e)});B.append(ka)}if(!C.html()){C.hide()}var ma=Q.find(".board_note").last();if(ma.length){y.insertAfter(ma)}else{Q.prepend(y)}}else{(0,c.default)(".board_column[data-ident="+a+"] .board_column_newcontent").append(y);R(e);D.editable("open");ja()}},fa=function(a,e,f){var h=t,i=null,j=(0,c.default)("<div class=\"board_column board_column_hasdata\" data-ident=\""+a+"\"></div>"),k=(0,c.default)("<div class=\"board_column_header\"></div>"),l=(0,c.default)("<div class=\"column_sort fa\"></div>"),m=(0,c.default)("<div class=\"column_name\" tabindex=\"0\" aria-level=\"3\" role=\"heading\">"+e+"</div>"),p=(0,c.default)("<div class=\"board_column_content\"></div>"),q=(0,c.default)("<div class=\"board_column_newcontent\"></div>");k.append(l);k.append(m);if(b.hideheaders){m.addClass("d-none")}l.on("click",function(){la(p,!0)});if(h){j.addClass("editablecolumn");var r=(0,c.default)("<div class=\"remove fa fa-remove delete_column\" role=\"button\" tabindex=\"0\"></div>");n(r,function(){g.default.confirm(d.remove_column_text.split(". ")[1],d.remove_column_text.split(". ")[0],d.Ok,d.Cancel,function(){G("delete_column",{id:a},function(a){if(a.status){j.remove();s=a.historyid}})})});k.append(r)}j.append(k);j.append(p);j.append(q);if(h){o(m,function(){i=m.html()},!0);m.editable({toggleFontSize:!1,closeOnEnter:!0,callback:function callback(b){if(b.content){G("update_column",{id:a,name:m.html()},function(b){if(!b.status){m.html(i);i=null}else{s=b.historyid;S(a)}},function(){m.html(i);i=null})}else{m.html(i);i=null}}})}if(!A){q.append("<div class=\"board_button newnote\" role=\"button\" tabindex=\"0\"><div class=\"button_content\"><span class=\"fa "+b.noteicon+"\"></span></div></div>");n(q.find(".newnote"),function(){ea(a,0,null,null,null,{id:u},0,0)})}var v=(0,c.default)(".mod_board .board_column_hasdata").last();if(v.length){j.insertAfter(v)}else{(0,c.default)(".mod_board").append(j)}if(f){for(var w in f){ea(a,f[w].id,f[w].heading,f[w].content,{type:f[w].type,info:f[w].info,url:f[w].url},{id:f[w].userid},f[w].timecreated,f[w].rating)}}la(p);S(a);if(t){ma()}},ga=function(){var e=(0,c.default)("<div class=\"board_column board_column_empty\"></div>"),f=!1;e.append("<div class=\"board_button newcolumn\" role=\"button\" tabindex=\"0\" aria-label=\""+d.aria_newcolumn+"\"><div class=\"button_content\"><span class=\"fa "+b.columnicon+"\"></span></div></div>");n(e.find(".newcolumn"),function(){if(f){return}f=!0;G("add_column",{boardid:a.id,name:d.default_column_heading},function(a){fa(a.id,d.default_column_heading);s=a.historyid;f=!1},function(){f=!1})});(0,c.default)(".mod_board").append(e)},ha=function(a,b,c){b.html(c.heading);if(c.heading){b.show()}else{b.hide()}J(a).html(c.content);Z(a,c.attachment);w=null;x=null;y=null;R(c.id)},ia=function(){G("board_history",{id:a.id,since:s},function(b){for(var e in b){var f=b[e];if(f.boardid!=a.id){continue}var h=JSON.parse(f.content);if("add_note"==f.action){ea(h.columnid,h.id,h.heading,h.content,h.attachment,{id:f.userid},h.timecreated,h.rating);R(h.id);la((0,c.default)(".board_column[data-ident="+h.columnid+"] .board_column_content"))}else if("update_note"==f.action){var i=H(h.id);if(i){var j=L(i);if(z==h.id){g.default.confirm(d.note_changed_text.split("\n")[0],d.note_changed_text.split("\n")[1],d.Ok,d.Cancel,function(a,b,c){ha(a,b,c);U()})}else{ha(i,j,h)}}}else if("delete_note"==f.action){if(z==h.id){g.default.alert(d.warning,d.note_deleted_text);U()}H(h.id).remove()}else if("add_column"==f.action){fa(h.id,h.name)}else if("update_column"==f.action){(0,c.default)(".board_column[data-ident='"+h.id+"'] .column_name").html(h.name);S(h.id)}else if("delete_column"==f.action){var k=(0,c.default)(".board_column[data-ident='"+h.id+"']");if(z&&k.find(".board_note[data-ident=\""+z+"\"]").length){U()}k.remove()}else if("rate_note"==f.action){var i=H(h.id);i.find(".rating").html(h.rating);if(F==q){la(i.closest(".board_column_content"))}}s=f.id}ja()})},ja=function(a){if(a){ia()}else if(0<b.history_refresh){if(r){ka()}r=setTimeout(ia,1e3*b.history_refresh)}},ka=function(){clearTimeout(r);r=null},la=function(a,b){var d=(0,c.default)(a).parent().find(".column_sort"),e=(0,c.default)(a).data("sort");if(!e){if(F==q){e="desc"}else{e="asc"}}if(b){e="asc"==e?"desc":"asc"}if("asc"==e){d.removeClass("fa-angle-down");d.addClass("fa-angle-up")}else{d.removeClass("fa-angle-up");d.addClass("fa-angle-down")}(0,c.default)(a).data("sort",e);if(F==p){var f=function(d,a){return(0,c.default)(a).data("sortorder")-(0,c.default)(d).data("sortorder")},g=function(d,a){return(0,c.default)(d).data("sortorder")-(0,c.default)(a).data("sortorder")}}else if(F==q){var f=function(d,a){return(0,c.default)(a).find(".rating").text()-(0,c.default)(d).find(".rating").text()||(0,c.default)(a).data("sortorder")-(0,c.default)(d).data("sortorder")},g=function(d,a){return(0,c.default)(d).find(".rating").text()-(0,c.default)(a).find(".rating").text()||(0,c.default)(d).data("sortorder")-(0,c.default)(a).data("sortorder")}}(0,c.default)("> .board_note",(0,c.default)(a)).sort("asc"==e?g:f).appendTo((0,c.default)(a))},ma=function(){(0,c.default)(".board_column_content").sortable({connectWith:".board_column_content",stop:function stop(a,b){var d=(0,c.default)(b.item),e=d.closest(".board_column"),f=e.data("ident"),g=(0,c.default)(this);G("move_note",{id:d.data("ident"),columnid:f},function(a){if(a.status){s=a.historyid;R(d.data("ident"));la((0,c.default)(".board_column[data-ident="+f+"] .board_column_content"))}else{g.sortable("cancel")}})}})},na=function(){G("get_board",{id:a.id},function(b){if(b){for(var c in b){fa(b[c].id,b[c].name,b[c].notes||{})}}if(t){ga()}s=a.historyid;if(t){ma()}ja()})},oa=[];for(var pa in d){oa.push({key:pa,component:"mod_board"})}c.default.when((0,e.get_strings)(oa)).done(function(a){var b=0;for(pa in d){d[pa]=a[b++]}na()})}return a.default});
//# sourceMappingURL=board.min.js.map
